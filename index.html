<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥æ¯›é€‰</title>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Ma+Shan+Zheng&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "STXingkai", "STKaiti", "KaiTi", "Ma Shan Zheng", "ZCOOL XiaoWei", "FangSong", serif;
            background: linear-gradient(135deg, #C41E3A 0%, #6B1B4D 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 60px 50px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
        }

        /* æ‰“å¡å¤©æ•° - å·¦ä¸Šè§’ */
        .check-in-days {
            position: absolute;
            top: 20px;
            left: 30px;
            font-size: 18px;
            color: #888;
            font-weight: 600;
            animation: pageFlip 0.6s ease-out;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px 15px;
            border-radius: 10px;
        }

        .check-in-days:hover {
            background: #f0f0f0;
            color: #C41E3A;
            transform: scale(1.05);
        }

        @keyframes pageFlip {
            0% {
                opacity: 0.3;
                transform: translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* é€šç”¨å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #DAA520;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 28px;
            color: #8B0000;
            font-weight: 700;
        }

        .edit-profile-btn {
            background: #DAA520;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .edit-profile-btn:hover {
            background: #B8860B;
        }

        .close-modal {
            background: #DC143C;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #B01030;
        }

        /* å¾½ç« å±•ç¤ºåŒº */
        .badges-section {
            background: linear-gradient(135deg, #FFF8DC 0%, #FFFAF0 100%);
            border: 2px solid #DAA520;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .badges-title {
            font-size: 20px;
            color: #8B0000;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .badge-icon {
            font-size: 50px;
            filter: grayscale(100%) opacity(0.3);
            transition: all 0.3s;
        }

        .badge-icon.earned {
            filter: grayscale(0%) opacity(1);
            animation: badgeEarn 0.6s ease-out;
        }

        @keyframes badgeEarn {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .badge-label {
            font-size: 12px;
            color: #888;
        }

        .badge-label.earned {
            color: #8B0000;
            font-weight: 700;
        }

        /* æ—¥å†æ ¼å­ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .calendar-weekday {
            font-size: 14px;
            font-weight: 700;
            color: #888;
            text-align: center;
            padding: 10px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            background: white;
            position: relative;
        }

        .calendar-day.weekend {
            background: #f8f8f8;
            color: #ccc;
        }

        .calendar-day.checked {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-color: #DAA520;
            color: white;
            font-weight: 700;
        }

        .calendar-day.today {
            border-color: #DC143C;
            border-width: 3px;
        }

        .check-mark {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 18px;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            color: #8B0000;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #888;
        }

        /* ç›¸å¤„æ¨¡å¼é€‰æ‹©å™¨ */
        .compatibility-selector {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .selector-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: center;
        }

        .selector-label {
            font-size: 16px;
            color: #333;
            font-weight: 600;
            min-width: 80px;
            text-align: right;
        }

        .selector-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }

        .selector-box select {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 2px solid #DAA520;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .selector-box select:focus {
            outline: none;
            border-color: #8B0000;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
        }

        .analyze-btn {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .analyze-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3);
        }

        /* ç›¸å¤„å»ºè®®ç»“æœ */
        .compatibility-result {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .compatibility-result.show {
            display: block;
        }

        .result-header {
            background: linear-gradient(135deg, #FFF8DC 0%, #FFFAF0 100%);
            border: 2px solid #DAA520;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .personality-combo {
            font-size: 24px;
            color: #8B0000;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .compatibility-score {
            font-size: 48px;
            color: #DC143C;
            font-weight: 900;
            margin: 15px 0;
        }

        .score-stars {
            font-size: 32px;
            color: #FFD700;
        }

        .result-section {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .result-section-title {
            font-size: 20px;
            color: #8B0000;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-section-content {
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            text-align: left;
        }

        .result-section-content ul {
            list-style: none;
            padding-left: 0;
        }

        .result-section-content li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .result-section-content li:before {
            content: "â€¢";
            position: absolute;
            left: 8px;
            color: #DAA520;
            font-weight: 700;
            font-size: 20px;
        }

        .quote-highlight {
            background: linear-gradient(135deg, #FFF8DC 0%, #FFFAF0 100%);
            border-left: 4px solid #DAA520;
            padding: 15px 20px;
            margin: 15px 0;
            font-size: 18px;
            font-weight: 600;
            font-style: italic;
            color: #1a1a1a;
        }

        /* åº•éƒ¨æŒ‰é’®ç»„ */
        .bottom-buttons {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            align-items: center;
        }

        .emperor-btn {
            font-size: 16px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
            padding: 5px 15px;
        }

        .emperor-btn:hover {
            color: #333;
            transform: scale(1.05);
        }

        /* æ”¶è—å’Œèœå• - å³ä¸‹è§’ */
        .bottom-actions {
            position: absolute;
            bottom: 20px;
            right: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .action-icon {
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .action-icon:hover {
            transform: scale(1.2);
        }

        .favorite-icon.unfavorited {
            color: #ddd;
        }

        .favorite-icon.favorited {
            color: #DC143C;
        }

        .menu-icon {
            font-size: 24px;
            cursor: pointer;
            color: #888;
            transition: all 0.3s;
            line-height: 1;
            font-weight: 700;
        }

        .menu-icon:hover {
            color: #333;
        }

        .compatibility-icon {
            color: #DAA520;
        }

        /* æŠ½å¡åŒºåŸŸ */
        .card-area {
            position: relative;
            min-height: 450px;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        .card-stack {
            position: absolute;
            width: 300px;
            height: 450px;
        }

        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #8B0000 0%, #DAA520 100%);
            border-radius: 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 52px;
            color: #FFD700;
            font-weight: 900;
            border: 3px solid #FFD700;
        }

        .card-flying {
            position: absolute;
            width: 300px;
            height: 450px;
            background: linear-gradient(135deg, #FFFAF0 0%, #FFF8DC 100%);
            border-radius: 0;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            border: 3px solid #DAA520;
            animation: cardFly 1.5s ease-out forwards;
            opacity: 0;
            z-index: 10;
        }

        @keyframes cardFly {
            0% {
                transform: translateY(0) scale(0.8) rotateY(0deg);
                opacity: 0;
            }
            30% {
                transform: translateY(-100px) scale(1.1) rotateY(180deg);
                opacity: 1;
            }
            60% {
                transform: translateY(-80px) scale(1.05) rotateY(360deg);
            }
            100% {
                transform: translateY(0) scale(1) rotateY(360deg);
                opacity: 1;
            }
        }

        .glow-effect {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.8) 0%, transparent 70%);
            border-radius: 50%;
            animation: glowPulse 1.5s ease-out;
            pointer-events: none;
            z-index: 5;
        }

        @keyframes glowPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* è¯­å½•å†…å®¹ */
        .quote-content {
            display: none;
            animation: fadeIn 1s ease-in;
        }

        .quote-content.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .title {
            font-size: 48px;
            color: #C41E3A;
            margin-bottom: 25px;
            font-weight: 900;
            letter-spacing: 8px;
        }

        .date {
            color: #888;
            font-size: 18px;
            margin-bottom: 40px;
            font-weight: 400;
        }

        .quote {
            font-size: 32px;
            line-height: 2.2;
            color: #1a1a1a;
            margin: 40px 0;
            font-weight: 700;
            letter-spacing: 3px;
            text-align: justify;
            text-justify: inter-ideograph;
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.15);
        }

        .source {
            color: #888;
            font-size: 20px;
            margin: 30px 0;
            font-weight: 600;
            letter-spacing: 3px;
        }

        .slogan {
            color: #888;
            font-size: 18px;
            margin-top: 20px;
            font-weight: 400;
            letter-spacing: 2px;
        }

        .fortune-section {
            margin-top: 40px;
            padding: 25px 30px;
            background: linear-gradient(135deg, #FFF8DC 0%, #FFFAF0 100%);
            border-radius: 0;
            border: 2px solid #DAA520;
        }

        .fortune-title {
            font-size: 22px;
            color: #8B0000;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .fortune-text {
            font-size: 18px;
            color: #333;
            line-height: 1.8;
            font-weight: 600;
        }

        .favorites-modal .modal-content {
            border-radius: 0;
        }

        .favorite-item {
            background: #FFF8DC;
            border: 2px solid #DAA520;
            border-radius: 0;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .favorite-quote-text {
            font-size: 18px;
            line-height: 1.8;
            color: #1a1a1a;
            margin-bottom: 10px;
        }

        .remove-favorite {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #DC143C;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 0;
            cursor: pointer;
            font-size: 12px;
        }

        .empty-favorites {
            text-align: center;
            color: #888;
            font-size: 18px;
            padding: 40px;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            background: transparent;
            color: #888;
            border: none;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            transition: all 0.3s;
        }

        .close-btn:hover {
            color: #333;
            transform: scale(1.1);
        }

    </style>
</head>
<body>
    <div class="container">
        <button class="close-btn" onclick="window.close()" title="å…³é—­">Ã—</button>
        <div class="check-in-days" id="checkInDays" onclick="showCalendar()" title="æŸ¥çœ‹æ‰“å¡æ—¥å†">æ‰“å¡ 1 å¤©</div>

        <div class="bottom-buttons">
            <span class="emperor-btn" onclick="redrawCard()">æœ•ä¸æ»¡æ„</span>
            <span class="emperor-btn" onclick="closeWindow()">æœ•å·²é˜…</span>
        </div>

        <div class="card-area" id="cardArea">
            <div class="card-stack">
                <div class="card-back">æ¯æ—¥æ¯›é€‰</div>
            </div>
        </div>

        <div class="quote-content" id="quoteContent">
            <div class="title">æ¯æ—¥æ¯›é€‰</div>
            <div class="date" id="date"></div>
            <div class="quote" id="quote"></div>
            <div class="source">â€”ã€Šæ¯›æ³½ä¸œé€‰é›†ã€‹â€”</div>
            <div class="slogan">æ¯å¤©ä¸€å¥ï¼Œæ¿€åŠ±å‰è¡Œ</div>

            <div class="fortune-section">
                <div class="fortune-title">ğŸ“‹ ä»Šæ—¥è¿åŠ¿</div>
                <div class="fortune-text" id="fortuneText"></div>
            </div>
        </div>

        <div class="bottom-actions">
            <span class="action-icon favorite-icon unfavorited" id="favoriteIcon" onclick="toggleFavorite()" title="æ”¶è—">â˜†</span>
            <span class="action-icon compatibility-icon" onclick="showCompatibility()" title="ç›¸å¤„æ¨¡å¼">ğŸ¤</span>
            <span class="action-icon menu-icon" onclick="viewFavorites()" title="æŸ¥çœ‹æ”¶è—">â‰¡</span>
        </div>
    </div>

    <!-- æ—¥å†å¼¹çª— -->
    <div class="modal" id="calendarModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="calendarHeaderTitle">ğŸ“… æ‰“å¡æ—¥å†</div>
                <div>
                    <button class="edit-profile-btn" onclick="editProfile()">âœï¸ ç¼–è¾‘èµ„æ–™</button>
                    <button class="close-modal" onclick="closeCalendar()">å…³é—­</button>
                </div>
            </div>

            <div class="badges-section">
                <div class="badges-title">ğŸ† æˆ‘çš„å¾½ç« </div>
                <div class="badges-container" id="badgesContainer"></div>
            </div>

            <div class="stats-section">
                <div class="stat-item">
                    <div class="stat-value" id="totalWorkdays">0</div>
                    <div class="stat-label">æ€»å·¥ä½œæ—¥æ‰“å¡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">è¿ç»­æ‰“å¡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="badgeCount">0</div>
                    <div class="stat-label">è·å¾—å¾½ç« </div>
                </div>
            </div>

            <div style="height: 20px;"></div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <!-- ç›¸å¤„æ¨¡å¼å¼¹çª— -->
    <div class="modal" id="compatibilityModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ¤ ç›¸å¤„æ¨¡å¼æŸ¥è¯¢å™¨</div>
                <button class="close-modal" onclick="closeCompatibility()">å…³é—­</button>
            </div>

            <div class="compatibility-selector">
                <div class="selector-row">
                    <div class="selector-label">å¯¹æ–¹MBTI:</div>
                    <div class="selector-box">
                        <select id="partnerMbti">
                            <option value="">è¯·é€‰æ‹©...</option>
                            <option value="INTJ">INTJ - å»ºç­‘å¸ˆ</option>
                            <option value="INTP">INTP - é€»è¾‘å­¦å®¶</option>
                            <option value="ENTJ">ENTJ - æŒ‡æŒ¥å®˜</option>
                            <option value="ENTP">ENTP - è¾©è®ºå®¶</option>
                            <option value="INFJ">INFJ - æå€¡è€…</option>
                            <option value="INFP">INFP - è°ƒåœè€…</option>
                            <option value="ENFJ">ENFJ - ä¸»äººå…¬</option>
                            <option value="ENFP">ENFP - ç«é€‰è€…</option>
                            <option value="ISTJ">ISTJ - ç‰©æµå¸ˆ</option>
                            <option value="ISFJ">ISFJ - å®ˆå«è€…</option>
                            <option value="ESTJ">ESTJ - æ€»ç»ç†</option>
                            <option value="ESFJ">ESFJ - æ‰§æ”¿å®˜</option>
                            <option value="ISTP">ISTP - é‰´èµå®¶</option>
                            <option value="ISFP">ISFP - æ¢é™©å®¶</option>
                            <option value="ESTP">ESTP - ä¼ä¸šå®¶</option>
                            <option value="ESFP">ESFP - è¡¨æ¼”è€…</option>
                        </select>
                    </div>
                </div>

                <div class="selector-row">
                    <div class="selector-label">å¯¹æ–¹æ˜Ÿåº§:</div>
                    <div class="selector-box">
                        <select id="partnerZodiac">
                            <option value="">è¯·é€‰æ‹©...</option>
                            <option value="ç™½ç¾Šåº§">â™ˆ ç™½ç¾Šåº§ (3.21-4.19)</option>
                            <option value="é‡‘ç‰›åº§">â™‰ é‡‘ç‰›åº§ (4.20-5.20)</option>
                            <option value="åŒå­åº§">â™Š åŒå­åº§ (5.21-6.21)</option>
                            <option value="å·¨èŸ¹åº§">â™‹ å·¨èŸ¹åº§ (6.22-7.22)</option>
                            <option value="ç‹®å­åº§">â™Œ ç‹®å­åº§ (7.23-8.22)</option>
                            <option value="å¤„å¥³åº§">â™ å¤„å¥³åº§ (8.23-9.22)</option>
                            <option value="å¤©ç§¤åº§">â™ å¤©ç§¤åº§ (9.23-10.23)</option>
                            <option value="å¤©èåº§">â™ å¤©èåº§ (10.24-11.22)</option>
                            <option value="å°„æ‰‹åº§">â™ å°„æ‰‹åº§ (11.23-12.21)</option>
                            <option value="æ‘©ç¾¯åº§">â™‘ æ‘©ç¾¯åº§ (12.22-1.19)</option>
                            <option value="æ°´ç“¶åº§">â™’ æ°´ç“¶åº§ (1.20-2.18)</option>
                            <option value="åŒé±¼åº§">â™“ åŒé±¼åº§ (2.19-3.20)</option>
                        </select>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button class="analyze-btn" onclick="analyzeCompatibility()">åˆ†æç›¸å¤„æ¨¡å¼</button>
                </div>
            </div>

            <div class="compatibility-result" id="compatibilityResult">
                <!-- ç»“æœå°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ”¶è—åˆ—è¡¨å¼¹çª— -->
    <div class="modal favorites-modal" id="favoritesModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æˆ‘çš„æ”¶è—</div>
                <button class="close-modal" onclick="closeFavorites()">å…³é—­</button>
            </div>
            <div id="favoritesList"></div>
        </div>
    </div>

    <script>
        console.log('è„šæœ¬å¼€å§‹åŠ è½½...');

        // è·å–æˆ–è®¾ç½®ç”¨æˆ·æ ‡è¯†å’Œä¸ªäººä¿¡æ¯
        function getUserInfo() {
            let userInfo = localStorage.getItem('maoismUserInfo');

            if (!userInfo) {
                // é¦–æ¬¡è®¿é—®ï¼Œæ”¶é›†ç”¨æˆ·ä¿¡æ¯
                let userId = '';
                while (!userId || userId.length !== 4 || isNaN(userId)) {
                    userId = prompt('ğŸ¯ æ¬¢è¿ä½¿ç”¨æ¯æ—¥æ¯›é€‰ï¼\n\nç¬¬1æ­¥ï¼šè¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·å4ä½ï¼š', '');
                    if (userId === null) {
                        userId = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                        break;
                    }
                    userId = userId.trim();
                    if (userId.length !== 4 || isNaN(userId)) {
                        alert('âŒ è¯·è¾“å…¥4ä½æ•°å­—');
                    }
                }

                // æ”¶é›†MBTI
                const mbtiList = ['INTJ', 'INTP', 'ENTJ', 'ENTP', 'INFJ', 'INFP', 'ENFJ', 'ENFP',
                                  'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ', 'ISTP', 'ISFP', 'ESTP', 'ESFP'];
                let mbti = '';
                while (!mbti || !mbtiList.includes(mbti.toUpperCase())) {
                    mbti = prompt('ğŸ§  ç¬¬2æ­¥ï¼šè¯·è¾“å…¥æ‚¨çš„MBTIäººæ ¼ç±»å‹ï¼ˆå¦‚ï¼šINTJï¼‰ï¼š\n\nä¸çŸ¥é“ï¼Ÿè®¿é—® 16personalities.com æµ‹è¯•', '');
                    if (mbti === null) {
                        mbti = mbtiList[Math.floor(Math.random() * mbtiList.length)];
                        break;
                    }
                    mbti = mbti.trim().toUpperCase();
                    if (!mbtiList.includes(mbti)) {
                        alert('âŒ è¯·è¾“å…¥æ­£ç¡®çš„MBTIç±»å‹ï¼ˆå¦‚ï¼šINTJã€ENFPç­‰ï¼‰');
                    }
                }

                // æ”¶é›†æ˜Ÿåº§
                const zodiacList = ['ç™½ç¾Šåº§', 'é‡‘ç‰›åº§', 'åŒå­åº§', 'å·¨èŸ¹åº§', 'ç‹®å­åº§', 'å¤„å¥³åº§',
                                    'å¤©ç§¤åº§', 'å¤©èåº§', 'å°„æ‰‹åº§', 'æ‘©ç¾¯åº§', 'æ°´ç“¶åº§', 'åŒé±¼åº§'];
                let zodiac = '';
                while (!zodiac || !zodiacList.includes(zodiac)) {
                    zodiac = prompt('â­ ç¬¬3æ­¥ï¼šè¯·è¾“å…¥æ‚¨çš„æ˜Ÿåº§ï¼ˆå¦‚ï¼šæ‘©ç¾¯åº§ï¼‰ï¼š', '');
                    if (zodiac === null) {
                        zodiac = zodiacList[Math.floor(Math.random() * zodiacList.length)];
                        break;
                    }
                    zodiac = zodiac.trim();
                    if (!zodiacList.includes(zodiac)) {
                        alert('âŒ è¯·è¾“å…¥æ­£ç¡®çš„æ˜Ÿåº§åç§°');
                    }
                }

                userInfo = {
                    userId: userId,
                    mbti: mbti,
                    zodiac: zodiac
                };

                localStorage.setItem('maoismUserInfo', JSON.stringify(userInfo));
                alert(`âœ… è´¦å·åˆ›å»ºæˆåŠŸï¼\n\nå°¾å·ï¼š${userId}\nMBTIï¼š${mbti}\næ˜Ÿåº§ï¼š${zodiac}`);
            } else {
                userInfo = JSON.parse(userInfo);
            }

            return userInfo;
        }

        const quotes = [
            "æˆ‘ä»¬çš„åŒå¿—åœ¨å›°éš¾çš„æ—¶å€™ï¼Œè¦çœ‹åˆ°æˆç»©ï¼Œè¦çœ‹åˆ°å…‰æ˜ï¼Œè¦æé«˜æˆ‘ä»¬çš„å‹‡æ°”ã€‚",
            "äººæ°‘ï¼Œåªæœ‰äººæ°‘ï¼Œæ‰æ˜¯åˆ›é€ ä¸–ç•Œå†å²çš„åŠ¨åŠ›ã€‚ä¸–ç•Œæ˜¯äººæ°‘çš„ï¼Œåšå·¥çš„äººæœ€æœ‰ç”¨ã€‚",
            "æ˜Ÿæ˜Ÿä¹‹ç«ï¼Œå¯ä»¥ç‡åŸã€‚é©å‘½çš„åŠ›é‡è™½ç„¶å¼€å§‹æ—¶å¾ˆå°ï¼Œä½†æ˜¯å®ƒçš„å‘å±•ä¼šéå¸¸è¿…é€Ÿã€‚",
            "æ²¡æœ‰è°ƒæŸ¥ï¼Œå°±æ²¡æœ‰å‘è¨€æƒã€‚ä¸åšæ­£ç¡®çš„è°ƒæŸ¥ï¼ŒåŒæ ·æ²¡æœ‰å‘è¨€æƒã€‚",
            "è™šå¿ƒä½¿äººè¿›æ­¥ï¼Œéª„å‚²ä½¿äººè½åã€‚æˆ‘ä»¬åº”å½“æ°¸è¿œè®°ä½è¿™ä¸ªçœŸç†ã€‚",
            "ä¸–ç•Œä¸Šæ€•å°±æ€•'è®¤çœŸ'äºŒå­—ï¼Œå…±äº§å…šå°±æœ€è®²è®¤çœŸã€‚",
            "ä¸‹å®šå†³å¿ƒï¼Œä¸æ€•ç‰ºç‰²ï¼Œæ’é™¤ä¸‡éš¾ï¼Œå»äº‰å–èƒœåˆ©ã€‚è¿™æ˜¯æˆ‘ä»¬çš„å£å·ã€‚",
            "å®äº‹æ±‚æ˜¯ï¼Œæ˜¯é©¬å…‹æ€ä¸»ä¹‰çš„æ ¹æœ¬è§‚ç‚¹ï¼Œæ˜¯ä¸­å›½å…±äº§å…šäººè®¤è¯†ä¸–ç•Œã€æ”¹é€ ä¸–ç•Œçš„æ ¹æœ¬è¦æ±‚ã€‚",
            "ä¸€ä¸‡å¹´å¤ªä¹…ï¼Œåªäº‰æœå¤•ã€‚æˆ‘ä»¬è¦æŠ“ç´§æ—¶é—´ï¼ŒåŠªåŠ›å·¥ä½œã€‚",
            "å¥½å¥½å­¦ä¹ ï¼Œå¤©å¤©å‘ä¸Šã€‚æˆ‘ä»¬è¦ä¸æ–­å­¦ä¹ æ–°çŸ¥è¯†ï¼Œæé«˜è‡ªå·±çš„æœ¬é¢†ã€‚"
        ];

        const fortuneTexts = [
            "ä»Šæ—¥é€‚åˆæ·±å…¥è°ƒç ”ã€ç†æ€§åˆ†æã€‚é‡äº‹å¤šè§‚å¯Ÿã€å¤šæ€è€ƒï¼Œå®äº‹æ±‚æ˜¯æ–¹èƒ½æ‰¾åˆ°æ­£ç¡®æ–¹å‘ã€‚",
            "ä»Šæ—¥é€‚åˆæ”»åšå…‹éš¾ã€è¿æ¥æŒ‘æˆ˜ã€‚å›°éš¾åªæ˜¯æš‚æ—¶çš„ï¼ŒåšæŒä¸æ‡ˆå¿…æœ‰æ”¶è·ã€‚",
            "ä»Šæ—¥å®œä½è°ƒè°¦é€Šï¼Œæˆ’éª„æˆ’èºã€‚è™šå¿ƒè¯·æ•™ä»–äººï¼Œä¼šæœ‰æ„å¤–çš„æ”¶è·å’Œå¸®åŠ©ã€‚",
            "ä»Šæ—¥äººé™…è¿ä½³ï¼Œé€‚åˆå›¢é˜Ÿåä½œã€‚å¤šå€¾å¬ä»–äººæ„è§ï¼Œç¾¤ç­–ç¾¤åŠ›äº‹åŠåŠŸå€ã€‚",
            "ä»Šæ—¥å­¦ä¹ è¿æ—ºï¼Œé€‚åˆé’»ç ”æ–°çŸ¥ã€‚ç†è®ºç»“åˆå®è·µï¼Œä¼šæœ‰æ–°çš„çªç ´å’Œé¢†æ‚Ÿã€‚"
        ];

        const badges = [
            { id: 1, icon: 'ğŸŒŸ', name: 'åˆå¿ƒä¸å¿˜', workdays: 7 },
            { id: 2, icon: 'â­', name: 'åšæŒä¸æ‡ˆ', workdays: 14 },
            { id: 3, icon: 'ğŸ’«', name: 'æŒä¹‹ä»¥æ’', workdays: 21 },
            { id: 4, icon: 'âœ¨', name: 'å‹¤å­¦è‹¦ç»ƒ', workdays: 28 },
            { id: 5, icon: 'ğŸ†', name: 'ç™¾ç‚¼æˆé’¢', workdays: 35 },
            { id: 6, icon: 'ğŸ‘‘', name: 'å­¦ä¹ æ ‡å…µ', workdays: 50 }
        ];

        // ç›¸å¤„å»ºè®®æ•°æ®åº“
        const compatibilityData = {
            // MBTIç›¸å¤„å»ºè®®
            mbti: {
                'INTJ-ENFP': {
                    score: 90,
                    strengths: ['æ€ç»´äº’è¡¥ï¼Œç†æ€§ä¸æ„Ÿæ€§å¹³è¡¡', 'INTJæä¾›æˆ˜ç•¥ï¼ŒENFPå¸¦æ¥åˆ›æ„', 'å…±åŒè¿½æ±‚æˆé•¿å’Œæ·±åº¦äº¤æµ'],
                    challenges: ['INTJéœ€è¦ç‹¬å¤„ï¼ŒENFPéœ€è¦äº’åŠ¨', 'INTJæ³¨é‡è®¡åˆ’ï¼ŒENFPåå¥½å³å…´'],
                    tips: ['ç»™å½¼æ­¤ç©ºé—´ï¼Œå°Šé‡ä¸åŒçš„èƒ½é‡éœ€æ±‚', 'å¤šè¿›è¡Œæ·±åº¦å¯¹è¯ï¼Œåˆ†äº«æƒ³æ³•å’Œæ„¿æ™¯', 'INTJå¯ä»¥æ›´å¼€æ”¾ï¼ŒENFPå¯ä»¥æ›´ä¸“æ³¨'],
                    quote: 'å›¢ç»“ä¸€åˆ‡å¯ä»¥å›¢ç»“çš„åŠ›é‡ã€‚å‘æŒ¥å„è‡ªä¼˜åŠ¿ï¼Œç†æ€§ä¸æ¿€æƒ…å¹¶é‡ï¼Œæ–¹èƒ½æˆå°±å¤§äº‹ã€‚'
                },
                'INTJ-INTJ': {
                    score: 75,
                    strengths: ['æ€ç»´æ–¹å¼é«˜åº¦ä¸€è‡´', 'éƒ½é‡è§†æ•ˆç‡å’Œé€»è¾‘', 'ç›¸äº’ç†è§£å¯¹ç‹¬å¤„çš„éœ€æ±‚'],
                    challenges: ['å¯èƒ½è¿‡äºç†æ€§ï¼Œç¼ºä¹æƒ…æ„Ÿè¡¨è¾¾', 'éƒ½å¾ˆå›ºæ‰§ï¼Œéš¾ä»¥å¦¥å'],
                    tips: ['ä¸»åŠ¨è¡¨è¾¾æƒ…æ„Ÿï¼Œä¸è¦åªè°ˆå·¥ä½œ', 'å­¦ä¼šå¦¥åï¼Œä¸æ˜¯æ¯ä»¶äº‹éƒ½è¦äº‰å¯¹é”™', 'å®šæœŸè¿›è¡Œæ·±åº¦äº¤æµï¼Œé¿å…ç–è¿œ'],
                    quote: 'è°¦è™šä½¿äººè¿›æ­¥ï¼Œéª„å‚²ä½¿äººè½åã€‚å³ä½¿è§‚ç‚¹ç›¸ä¼¼ï¼Œä¹Ÿè¦ä¿æŒå¼€æ”¾å¿ƒæ€ï¼Œäº’ç›¸å­¦ä¹ ã€‚'
                },
                'ENTJ-ENTJ': {
                    score: 70,
                    strengths: ['éƒ½æ˜¯å¤©ç”Ÿçš„é¢†å¯¼è€…', 'é«˜æ•ˆæ‰§è¡ŒåŠ›', 'ç›®æ ‡å¯¼å‘ä¸€è‡´'],
                    challenges: ['æƒåŠ›äº‰å¤ºï¼Œéƒ½æƒ³ä¸»å¯¼', 'ç«äº‰å¯èƒ½å¤§äºåˆä½œ'],
                    tips: ['æ˜ç¡®åˆ†å·¥ï¼Œå„å¸å…¶èŒ', 'å°†ç«äº‰è½¬åŒ–ä¸ºè‰¯æ€§ç«äº‰', 'å­¦ä¼šå€¾å¬å’Œå¦¥å'],
                    quote: 'ä¸‹å®šå†³å¿ƒï¼Œä¸æ€•ç‰ºç‰²ï¼Œæ’é™¤ä¸‡éš¾ï¼Œå»äº‰å–èƒœåˆ©ã€‚å…±åŒçš„ç›®æ ‡æ¯”ä¸ªäººæƒå¨æ›´é‡è¦ã€‚'
                },
                'INFJ-INFJ': {
                    score: 85,
                    strengths: ['æ·±åˆ»ç†è§£å½¼æ­¤çš„æƒ…æ„Ÿ', 'å…±åŒçš„ä»·å€¼è§‚å’Œç†æƒ³', 'éƒ½å¾ˆæœ‰åŒç†å¿ƒ'],
                    challenges: ['å¯èƒ½è¿‡äºæƒ…ç»ªåŒ–', 'éƒ½å€¾å‘äºå›é¿å†²çª'],
                    tips: ['å­¦ä¼šç›´é¢é—®é¢˜ï¼Œä¸è¦é€ƒé¿', 'ç»™å½¼æ­¤æƒ…æ„Ÿæ”¯æŒçš„åŒæ—¶ä¹Ÿè¦ç‹¬ç«‹', 'ä¿æŒç°å®æ„Ÿï¼Œä¸è¦è¿‡äºç†æƒ³åŒ–'],
                    quote: 'å®äº‹æ±‚æ˜¯ï¼Œæ˜¯è®¤è¯†ä¸–ç•Œã€æ”¹é€ ä¸–ç•Œçš„æ ¹æœ¬è¦æ±‚ã€‚ç†æƒ³è¦å»ºç«‹åœ¨ç°å®åŸºç¡€ä¸Šã€‚'
                },
                'ENFP-INTJ': {
                    score: 90,
                    strengths: ['æ€ç»´äº’è¡¥ï¼Œç†æ€§ä¸æ„Ÿæ€§å¹³è¡¡', 'INTJæä¾›æˆ˜ç•¥ï¼ŒENFPå¸¦æ¥åˆ›æ„', 'å…±åŒè¿½æ±‚æˆé•¿å’Œæ·±åº¦äº¤æµ'],
                    challenges: ['INTJéœ€è¦ç‹¬å¤„ï¼ŒENFPéœ€è¦äº’åŠ¨', 'INTJæ³¨é‡è®¡åˆ’ï¼ŒENFPåå¥½å³å…´'],
                    tips: ['ç»™å½¼æ­¤ç©ºé—´ï¼Œå°Šé‡ä¸åŒçš„èƒ½é‡éœ€æ±‚', 'å¤šè¿›è¡Œæ·±åº¦å¯¹è¯ï¼Œåˆ†äº«æƒ³æ³•å’Œæ„¿æ™¯', 'INTJå¯ä»¥æ›´å¼€æ”¾ï¼ŒENFPå¯ä»¥æ›´ä¸“æ³¨'],
                    quote: 'å›¢ç»“ä¸€åˆ‡å¯ä»¥å›¢ç»“çš„åŠ›é‡ã€‚å‘æŒ¥å„è‡ªä¼˜åŠ¿ï¼Œç†æ€§ä¸æ¿€æƒ…å¹¶é‡ï¼Œæ–¹èƒ½æˆå°±å¤§äº‹ã€‚'
                },
                'ISTJ-ESFP': {
                    score: 60,
                    strengths: ['äº’è¡¥æ€§å¼ºï¼Œä¸€ä¸ªåŠ¡å®ä¸€ä¸ªæ´»æ³¼', 'ISTJæä¾›ç¨³å®šï¼ŒESFPå¸¦æ¥ä¹è¶£'],
                    challenges: ['ç”Ÿæ´»æ–¹å¼å·®å¼‚å¤§', 'ISTJä¿å®ˆï¼ŒESFPå†²åŠ¨'],
                    tips: ['å°Šé‡å½¼æ­¤çš„ç”Ÿæ´»æ–¹å¼', 'ISTJå¯ä»¥æ›´çµæ´»ï¼ŒESFPå¯ä»¥æ›´æœ‰è®¡åˆ’', 'å¯»æ‰¾å…±åŒå…´è¶£ç‚¹'],
                    quote: 'ä¸–ç•Œä¸Šæ€•å°±æ€•è®¤çœŸäºŒå­—ã€‚ISTJçš„è®¤çœŸå’ŒESFPçš„çƒ­æƒ…ç»“åˆï¼Œèƒ½åˆ›é€ æ„æƒ³ä¸åˆ°çš„æˆæœã€‚'
                }
            },
            // æ˜Ÿåº§ç›¸å¤„å»ºè®®
            zodiac: {
                'æ‘©ç¾¯åº§-åŒå­åº§': {
                    score: 65,
                    strengths: ['æ‘©ç¾¯çš„ç¨³é‡å’ŒåŒå­çš„çµæ´»äº’è¡¥', 'å¯ä»¥äº’ç›¸å­¦ä¹ ä¸åŒçš„æ€ç»´æ–¹å¼'],
                    challenges: ['ä»·å€¼è§‚å·®å¼‚è¾ƒå¤§', 'æ‘©ç¾¯åŠ¡å®ï¼ŒåŒå­çˆ±å˜åŒ–'],
                    tips: ['æ‘©ç¾¯è¦æ›´å¼€æ”¾ï¼ŒåŒå­è¦æ›´ä¸“æ³¨', 'åœ¨å·¥ä½œä¸­åˆä½œæ•ˆæœæ›´å¥½'],
                    quote: 'æ²¡æœ‰è°ƒæŸ¥ï¼Œå°±æ²¡æœ‰å‘è¨€æƒã€‚å¤šäº†è§£å¯¹æ–¹çš„æƒ³æ³•ï¼Œæ‰èƒ½æ›´å¥½ç›¸å¤„ã€‚'
                },
                'ç™½ç¾Šåº§-ç‹®å­åº§': {
                    score: 90,
                    strengths: ['éƒ½å……æ»¡æ¿€æƒ…å’Œæ´»åŠ›', 'ç›¸äº’æ¬£èµå½¼æ­¤çš„å‹‡æ°”', 'ç«è±¡æ˜Ÿåº§å¤©ç„¶å¥‘åˆ'],
                    challenges: ['éƒ½å¾ˆå¼ºåŠ¿ï¼Œå¯èƒ½äº§ç”Ÿå†²çª', 'ç«äº‰å¿ƒç†å¼º'],
                    tips: ['å­¦ä¼šè½®æµä¸»å¯¼', 'å°†ç«äº‰è½¬åŒ–ä¸ºå…±åŒç›®æ ‡', 'äº’ç›¸æ¿€åŠ±è€Œéå¯¹æŠ—'],
                    quote: 'æ˜Ÿæ˜Ÿä¹‹ç«ï¼Œå¯ä»¥ç‡åŸã€‚ä¸¤ä¸ªå……æ»¡æ¿€æƒ…çš„äººï¼Œèƒ½åˆ›é€ å·¨å¤§çš„èƒ½é‡ã€‚'
                },
                'é‡‘ç‰›åº§-å¤„å¥³åº§': {
                    score: 95,
                    strengths: ['éƒ½æ³¨é‡å®é™…å’Œç»†èŠ‚', 'åœŸè±¡æ˜Ÿåº§å¤©ç„¶å¥‘åˆ', 'ä»·å€¼è§‚ä¸€è‡´'],
                    challenges: ['å¯èƒ½è¿‡äºä¿å®ˆ', 'ç¼ºä¹å†’é™©ç²¾ç¥'],
                    tips: ['å¶å°”æ‰“ç ´å¸¸è§„ï¼Œå°è¯•æ–°äº‹ç‰©', 'ç›¸äº’æ”¯æŒï¼Œå…±åŒæˆé•¿'],
                    quote: 'å®è·µæ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†ã€‚åŠ¡å®çš„ä¸¤äººåˆä½œï¼Œèƒ½åšå‡ºå®åœ¨çš„æˆæœã€‚'
                },
                'å¤©èåº§-åŒé±¼åº§': {
                    score: 92,
                    strengths: ['æ°´è±¡æ˜Ÿåº§ï¼Œæƒ…æ„Ÿå…±é¸£å¼º', 'æ·±åˆ»ç†è§£å½¼æ­¤', 'éƒ½å¾ˆæœ‰ç›´è§‰'],
                    challenges: ['å¯èƒ½è¿‡äºæƒ…ç»ªåŒ–', 'å®¹æ˜“é™·å…¥è´Ÿé¢æƒ…ç»ª'],
                    tips: ['ä¿æŒç†æ€§ï¼Œä¸è¦è¢«æƒ…ç»ªä¸»å¯¼', 'ç›¸äº’æ”¯æŒä½†ä¹Ÿè¦ç‹¬ç«‹', 'å¤šå‚ä¸ç§¯æçš„æ´»åŠ¨'],
                    quote: 'æˆ‘ä»¬çš„åŒå¿—åœ¨å›°éš¾çš„æ—¶å€™ï¼Œè¦çœ‹åˆ°æˆç»©ï¼Œè¦çœ‹åˆ°å…‰æ˜ã€‚æƒ…æ„Ÿæ·±åšçš„ä½ ä»¬ï¼Œæ›´è¦ä¿æŒä¹è§‚ã€‚'
                }
            }
        };

        let currentQuoteIndex = 0;

        function isWorkday(date) {
            const day = date.getDay();
            return day >= 1 && day <= 5;
        }

        function getDateStr(date) {
            return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
        }

        function closeWindow() {
            window.close();
        }

        function getTodayStr() {
            const now = new Date();
            return `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
        }

        function showDate() {
            const now = new Date();
            const dateStr = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][now.getDay()]}`;
            document.getElementById('date').textContent = dateStr;
        }

        function showCalendar() {
            const userInfo = getUserInfo();
            document.getElementById('calendarHeaderTitle').textContent = `ğŸ“… æ‰“å¡æ—¥å†ï¼ˆ${userInfo.mbti} ${userInfo.zodiac}ï¼‰`;
            renderCalendar();
            document.getElementById('calendarModal').classList.add('show');
        }

        function closeCalendar() {
            document.getElementById('calendarModal').classList.remove('show');
        }

        // ç¼–è¾‘ä¸ªäººèµ„æ–™
        function editProfile() {
            const userInfo = getUserInfo();

            if (!confirm(`å½“å‰èµ„æ–™ï¼š\nå°¾å·ï¼š${userInfo.userId}\nMBTIï¼š${userInfo.mbti}\næ˜Ÿåº§ï¼š${userInfo.zodiac}\n\nç¡®å®šè¦ä¿®æ”¹èµ„æ–™å—ï¼Ÿ`)) {
                return;
            }

            // ä¿®æ”¹MBTI
            const mbtiList = ['INTJ', 'INTP', 'ENTJ', 'ENTP', 'INFJ', 'INFP', 'ENFJ', 'ENFP',
                              'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ', 'ISTP', 'ISFP', 'ESTP', 'ESFP'];
            let newMbti = '';
            while (!newMbti || !mbtiList.includes(newMbti.toUpperCase())) {
                newMbti = prompt(`ğŸ§  è¯·è¾“å…¥æ–°çš„MBTIäººæ ¼ç±»å‹ï¼ˆå½“å‰ï¼š${userInfo.mbti}ï¼‰ï¼š`, userInfo.mbti);
                if (newMbti === null) return; // ç”¨æˆ·å–æ¶ˆ
                newMbti = newMbti.trim().toUpperCase();
                if (!mbtiList.includes(newMbti)) {
                    alert('âŒ è¯·è¾“å…¥æ­£ç¡®çš„MBTIç±»å‹ï¼ˆå¦‚ï¼šINTJã€ENFPç­‰ï¼‰');
                }
            }

            // ä¿®æ”¹æ˜Ÿåº§
            const zodiacList = ['ç™½ç¾Šåº§', 'é‡‘ç‰›åº§', 'åŒå­åº§', 'å·¨èŸ¹åº§', 'ç‹®å­åº§', 'å¤„å¥³åº§',
                                'å¤©ç§¤åº§', 'å¤©èåº§', 'å°„æ‰‹åº§', 'æ‘©ç¾¯åº§', 'æ°´ç“¶åº§', 'åŒé±¼åº§'];
            let newZodiac = '';
            while (!newZodiac || !zodiacList.includes(newZodiac)) {
                newZodiac = prompt(`â­ è¯·è¾“å…¥æ–°çš„æ˜Ÿåº§ï¼ˆå½“å‰ï¼š${userInfo.zodiac}ï¼‰ï¼š`, userInfo.zodiac);
                if (newZodiac === null) return; // ç”¨æˆ·å–æ¶ˆ
                newZodiac = newZodiac.trim();
                if (!zodiacList.includes(newZodiac)) {
                    alert('âŒ è¯·è¾“å…¥æ­£ç¡®çš„æ˜Ÿåº§åç§°');
                }
            }

            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            userInfo.mbti = newMbti;
            userInfo.zodiac = newZodiac;
            localStorage.setItem('maoismUserInfo', JSON.stringify(userInfo));

            alert(`âœ… èµ„æ–™æ›´æ–°æˆåŠŸï¼\n\nMBTIï¼š${newMbti}\næ˜Ÿåº§ï¼š${newZodiac}`);

            // åˆ·æ–°æ—¥å†æ˜¾ç¤º
            closeCalendar();
            showCalendar();
        }

        function renderCalendar() {
            const userInfo = getUserInfo();
            const storageKey = `dailyMaoism_${userInfo.userId}`;
            const data = JSON.parse(localStorage.getItem(storageKey)) || { checkInDates: [], favorites: [] };
            const grid = document.getElementById('calendarGrid');
            const today = new Date();

            const days = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                days.push(date);
            }

            const firstDay = days[0].getDay();
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

            grid.innerHTML = weekdays.map(day =>
                `<div class="calendar-weekday">${day}</div>`
            ).join('');

            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += '<div></div>';
            }

            const todayStr = getDateStr(today);
            days.forEach(date => {
                const dateStr = getDateStr(date);
                const isToday = dateStr === todayStr;
                const isWeekend = !isWorkday(date);
                const isChecked = data.checkInDates && data.checkInDates.includes(dateStr);

                const classes = ['calendar-day'];
                if (isWeekend) classes.push('weekend');
                if (isChecked) classes.push('checked');
                if (isToday) classes.push('today');

                grid.innerHTML += `
                    <div class="${classes.join(' ')}">
                        <div>${date.getDate()}</div>
                        ${isChecked ? '<div class="check-mark">âœ“</div>' : ''}
                    </div>
                `;
            });

            renderBadges(data);
            renderStats(data);
        }

        function renderBadges(data) {
            const workdayCount = data.checkInDates ? data.checkInDates.filter(dateStr => {
                const [year, month, day] = dateStr.split('-');
                const date = new Date(year, month - 1, day);
                return isWorkday(date);
            }).length : 0;

            const container = document.getElementById('badgesContainer');
            container.innerHTML = badges.map(badge => {
                const earned = workdayCount >= badge.workdays;
                return `
                    <div class="badge-item">
                        <div class="badge-icon ${earned ? 'earned' : ''}">${badge.icon}</div>
                        <div class="badge-label ${earned ? 'earned' : ''}">${badge.name}</div>
                        <div style="font-size: 11px; color: #aaa;">${badge.workdays}å¤©</div>
                    </div>
                `;
            }).join('');
        }

        function renderStats(data) {
            const workdayCount = data.checkInDates ? data.checkInDates.filter(dateStr => {
                const [year, month, day] = dateStr.split('-');
                const date = new Date(year, month - 1, day);
                return isWorkday(date);
            }).length : 0;

            const earnedBadges = badges.filter(badge => workdayCount >= badge.workdays).length;

            let streak = 0;
            if (data.checkInDates && data.checkInDates.length > 0) {
                const sortedDates = [...data.checkInDates].sort().reverse();
                const today = new Date();
                let checkDate = new Date(today);

                for (let i = 0; i < 100; i++) {
                    if (!isWorkday(checkDate)) {
                        checkDate.setDate(checkDate.getDate() - 1);
                        continue;
                    }

                    const dateStr = getDateStr(checkDate);
                    if (sortedDates.includes(dateStr)) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        break;
                    }
                }
            }

            document.getElementById('totalWorkdays').textContent = workdayCount;
            document.getElementById('currentStreak').textContent = streak;
            document.getElementById('badgeCount').textContent = earnedBadges;
        }

        // ç›¸å¤„æ¨¡å¼åŠŸèƒ½
        function showCompatibility() {
            document.getElementById('compatibilityModal').classList.add('show');
            document.getElementById('compatibilityResult').classList.remove('show');
        }

        function closeCompatibility() {
            document.getElementById('compatibilityModal').classList.remove('show');
        }

        function analyzeCompatibility() {
            const partnerMbti = document.getElementById('partnerMbti').value;
            const partnerZodiac = document.getElementById('partnerZodiac').value;

            if (!partnerMbti || !partnerZodiac) {
                alert('è¯·é€‰æ‹©å¯¹æ–¹çš„MBTIå’Œæ˜Ÿåº§ï¼');
                return;
            }

            const userInfo = getUserInfo();
            const myMbti = userInfo.mbti;
            const myZodiac = userInfo.zodiac;

            // æŸ¥æ‰¾ç›¸å¤„å»ºè®®
            const mbtiKey1 = `${myMbti}-${partnerMbti}`;
            const mbtiKey2 = `${partnerMbti}-${myMbti}`;
            const mbtiMatch = compatibilityData.mbti[mbtiKey1] || compatibilityData.mbti[mbtiKey2] || getDefaultMbtiMatch(myMbti, partnerMbti);

            const zodiacKey1 = `${myZodiac}-${partnerZodiac}`;
            const zodiacKey2 = `${partnerZodiac}-${myZodiac}`;
            const zodiacMatch = compatibilityData.zodiac[zodiacKey1] || compatibilityData.zodiac[zodiacKey2] || getDefaultZodiacMatch(myZodiac, partnerZodiac);

            // ç»¼åˆè¯„åˆ†
            const totalScore = Math.round((mbtiMatch.score + zodiacMatch.score) / 2);

            // ç”Ÿæˆæ˜Ÿçº§
            const stars = 'â˜…'.repeat(Math.round(totalScore / 20)) + 'â˜†'.repeat(5 - Math.round(totalScore / 20));

            // æ¸²æŸ“ç»“æœ
            const resultHtml = `
                <div class="result-header">
                    <div class="personality-combo">
                        ä½ ï¼ˆ${myMbti} ${myZodiac}ï¼‰ Ã— å¯¹æ–¹ï¼ˆ${partnerMbti} ${partnerZodiac}ï¼‰
                    </div>
                    <div class="compatibility-score">${totalScore}åˆ†</div>
                    <div class="score-stars">${stars}</div>
                </div>

                <div class="result-section">
                    <div class="result-section-title">ğŸ¯ MBTIç›¸å¤„è¦ç‚¹</div>
                    <div class="result-section-content">
                        <p><strong>ä¼˜åŠ¿äº’è¡¥ï¼š</strong></p>
                        <ul>
                            ${mbtiMatch.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                        <p><strong>æ½œåœ¨æŒ‘æˆ˜ï¼š</strong></p>
                        <ul>
                            ${mbtiMatch.challenges.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                        <p><strong>ç›¸å¤„å»ºè®®ï¼š</strong></p>
                        <ul>
                            ${mbtiMatch.tips.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div class="result-section">
                    <div class="result-section-title">â­ æ˜Ÿåº§ç›¸å¤„æŒ‡å—</div>
                    <div class="result-section-content">
                        <p><strong>ä¼˜åŠ¿äº’è¡¥ï¼š</strong></p>
                        <ul>
                            ${zodiacMatch.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                        <p><strong>éœ€è¦æ³¨æ„ï¼š</strong></p>
                        <ul>
                            ${zodiacMatch.challenges.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                        <p><strong>å»ºè®®ï¼š</strong></p>
                        <ul>
                            ${zodiacMatch.tips.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div class="result-section">
                    <div class="result-section-title">ğŸ“– æ¯›é€‰æŒ‡å¯¼</div>
                    <div class="result-section-content">
                        <div class="quote-highlight">${mbtiMatch.quote}</div>
                        <div class="quote-highlight">${zodiacMatch.quote}</div>
                    </div>
                </div>

                <div class="result-section">
                    <div class="result-section-title">ğŸ’¡ ä»Šæ—¥ç›¸å¤„å»ºè®®</div>
                    <div class="result-section-content">
                        <p>${getDailyAdvice(myMbti, partnerMbti, myZodiac, partnerZodiac)}</p>
                    </div>
                </div>
            `;

            document.getElementById('compatibilityResult').innerHTML = resultHtml;
            document.getElementById('compatibilityResult').classList.add('show');
        }

        // é»˜è®¤MBTIåŒ¹é…ï¼ˆå½“æ•°æ®åº“ä¸­æ²¡æœ‰æ—¶ï¼‰
        function getDefaultMbtiMatch(mbti1, mbti2) {
            const score = 70 + Math.floor(Math.random() * 20);
            return {
                score: score,
                strengths: ['å¯ä»¥äº’ç›¸å­¦ä¹ ä¸åŒçš„æ€ç»´æ–¹å¼', 'å„æœ‰ä¼˜åŠ¿ï¼Œå¯ä»¥äº’è¡¥'],
                challenges: ['éœ€è¦æ—¶é—´äº†è§£å½¼æ­¤', 'æ²Ÿé€šæ–¹å¼å¯èƒ½ä¸åŒ'],
                tips: ['ä¿æŒå¼€æ”¾å¿ƒæ€', 'å¤šè¿›è¡Œæ·±åº¦äº¤æµ', 'å°Šé‡å½¼æ­¤çš„å·®å¼‚'],
                quote: 'å›¢ç»“ä¸€åˆ‡å¯ä»¥å›¢ç»“çš„åŠ›é‡ã€‚ç†è§£å·®å¼‚ï¼Œå‘æŒ¥å„è‡ªä¼˜åŠ¿ï¼Œæ–¹èƒ½å…±åŒè¿›æ­¥ã€‚'
            };
        }

        // é»˜è®¤æ˜Ÿåº§åŒ¹é…
        function getDefaultZodiacMatch(zodiac1, zodiac2) {
            const score = 65 + Math.floor(Math.random() * 25);
            return {
                score: score,
                strengths: ['æ˜Ÿåº§ç‰¹è´¨å¯ä»¥äº’è¡¥', 'å„æœ‰æ‰€é•¿'],
                challenges: ['éœ€è¦ç£¨åˆ', 'æ€§æ ¼å·®å¼‚éœ€è¦ç†è§£'],
                tips: ['äº’ç›¸åŒ…å®¹', 'å¯»æ‰¾å…±åŒå…´è¶£', 'ä¿æŒè€å¿ƒ'],
                quote: 'ä¸–ç•Œä¸Šæ€•å°±æ€•è®¤çœŸäºŒå­—ã€‚è®¤çœŸå¯¹å¾…è¿™æ®µå…³ç³»ï¼Œç”¨å¿ƒç»è¥ï¼Œå®šèƒ½å¼€èŠ±ç»“æœã€‚'
            };
        }

        // ç”Ÿæˆä»Šæ—¥ç›¸å¤„å»ºè®®
        function getDailyAdvice(myMbti, partnerMbti, myZodiac, partnerZodiac) {
            const advices = [
                `ä»Šå¤©é€‚åˆå’Œ${partnerMbti}ç±»å‹çš„äººä¸€èµ·å¤´è„‘é£æš´ï¼Œä½ ä»¬çš„æ€ç»´ç¢°æ’ä¼šäº§ç”Ÿåˆ›æ„ç«èŠ±ã€‚`,
                `${myZodiac}å’Œ${partnerZodiac}ä»Šå¤©çš„èƒ½é‡åœºå¾ˆå¥‘åˆï¼Œé€‚åˆæ·±å…¥äº¤æµæˆ–åˆä½œé¡¹ç›®ã€‚`,
                `å»ºè®®ä»Šå¤©ä¸»åŠ¨å€¾å¬å¯¹æ–¹çš„æƒ³æ³•ï¼Œ${partnerMbti}çš„è§†è§’å¯èƒ½ä¼šç»™ä½ æ–°çš„å¯å‘ã€‚`,
                `ä»Šå¤©é€‚åˆä¸€èµ·åšåŠ¡å®çš„å·¥ä½œï¼Œå‘æŒ¥å„è‡ªä¼˜åŠ¿ï¼Œäº‹åŠåŠŸå€ã€‚`,
                `${myZodiac}çš„ä½ ä»Šå¤©å¯ä»¥æ›´ä¸»åŠ¨ä¸€äº›ï¼Œ${partnerZodiac}ä¼šæ¬£èµä½ çš„ç§¯ææ€åº¦ã€‚`
            ];
            return advices[Math.floor(Math.random() * advices.length)];
        }

        function init() {
            console.log('åˆå§‹åŒ–å¼€å§‹...');

            const userInfo = getUserInfo();
            console.log('å½“å‰ç”¨æˆ·ä¿¡æ¯:', userInfo);

            showDate();

            const storageKey = `dailyMaoism_${userInfo.userId}`;
            let data = localStorage.getItem(storageKey);

            if (!data) {
                data = {
                    userId: userInfo.userId,
                    lastDate: '',
                    checkInDates: [],
                    favorites: []
                };
            } else {
                data = JSON.parse(data);
                if (!data.checkInDates) {
                    data.checkInDates = [];
                }
            }

            const today = getTodayStr();
            const todayDate = new Date();

            if (data.lastDate !== today) {
                data.lastDate = today;
                if (isWorkday(todayDate)) {
                    if (!data.checkInDates.includes(today)) {
                        data.checkInDates.push(today);
                    }
                }
                localStorage.setItem(storageKey, JSON.stringify(data));
            } else {
                if (isWorkday(todayDate) && !data.checkInDates.includes(today)) {
                    data.checkInDates.push(today);
                    localStorage.setItem(storageKey, JSON.stringify(data));
                }
            }

            const workdayCount = data.checkInDates.filter(dateStr => {
                const [year, month, day] = dateStr.split('-');
                const date = new Date(year, month - 1, day);
                return isWorkday(date);
            }).length;

            document.getElementById('checkInDays').textContent = `æ‰“å¡ ${workdayCount} å¤©`;

            setTimeout(() => {
                playCardAnimation();
            }, 500);
        }

        function drawQuote() {
            currentQuoteIndex = Math.floor(Math.random() * quotes.length);
            return true;
        }

        function redrawCard() {
            drawQuote();
            document.getElementById('quoteContent').classList.remove('show');
            document.getElementById('cardArea').style.display = 'flex';
            setTimeout(() => {
                playCardAnimation();
            }, 300);
        }

        function playCardAnimation() {
            drawQuote();
            const cardArea = document.getElementById('cardArea');

            const glow = document.createElement('div');
            glow.className = 'glow-effect';
            cardArea.appendChild(glow);

            const flyingCard = document.createElement('div');
            flyingCard.className = 'card-flying';
            cardArea.appendChild(flyingCard);

            setTimeout(() => {
                cardArea.style.display = 'none';
                showQuoteContent();
            }, 1500);
        }

        function showQuoteContent() {
            const quote = quotes[currentQuoteIndex];
            document.getElementById('quote').textContent = quote;

            const fortune = fortuneTexts[currentQuoteIndex % fortuneTexts.length];
            document.getElementById('fortuneText').textContent = fortune;

            updateFavoriteIcon();
            document.getElementById('quoteContent').classList.add('show');
        }

        function toggleFavorite() {
            const userInfo = getUserInfo();
            const storageKey = `dailyMaoism_${userInfo.userId}`;
            let data = JSON.parse(localStorage.getItem(storageKey));
            const index = data.favorites.indexOf(currentQuoteIndex);

            if (index > -1) {
                data.favorites.splice(index, 1);
            } else {
                data.favorites.push(currentQuoteIndex);
            }

            localStorage.setItem(storageKey, JSON.stringify(data));
            updateFavoriteIcon();
        }

        function updateFavoriteIcon() {
            const userInfo = getUserInfo();
            const storageKey = `dailyMaoism_${userInfo.userId}`;
            const icon = document.getElementById('favoriteIcon');
            const data = JSON.parse(localStorage.getItem(storageKey));
            const isFavorited = data.favorites.includes(currentQuoteIndex);

            if (isFavorited) {
                icon.textContent = 'â˜…';
                icon.className = 'action-icon favorite-icon favorited';
            } else {
                icon.textContent = 'â˜†';
                icon.className = 'action-icon favorite-icon unfavorited';
            }
        }

        function viewFavorites() {
            const userInfo = getUserInfo();
            const storageKey = `dailyMaoism_${userInfo.userId}`;
            const modal = document.getElementById('favoritesModal');
            const listEl = document.getElementById('favoritesList');
            const data = JSON.parse(localStorage.getItem(storageKey));
            const favorites = data.favorites;

            if (favorites.length === 0) {
                listEl.innerHTML = '<div class="empty-favorites">æš‚æ— æ”¶è—ï¼Œå¿«å»æ”¶è—å–œæ¬¢çš„è¯­å½•å§ï¼</div>';
            } else {
                listEl.innerHTML = favorites.map(index => `
                    <div class="favorite-item">
                        <div class="favorite-quote-text">${quotes[index]}</div>
                        <button class="remove-favorite" onclick="removeFavorite(${index})">å–æ¶ˆæ”¶è—</button>
                    </div>
                `).join('');
            }

            modal.classList.add('show');
        }

        function closeFavorites() {
            document.getElementById('favoritesModal').classList.remove('show');
        }

        function removeFavorite(index) {
            const userInfo = getUserInfo();
            const storageKey = `dailyMaoism_${userInfo.userId}`;
            let data = JSON.parse(localStorage.getItem(storageKey));
            const favIndex = data.favorites.indexOf(index);
            if (favIndex > -1) {
                data.favorites.splice(favIndex, 1);
            }
            localStorage.setItem(storageKey, JSON.stringify(data));

            viewFavorites();

            if (index === currentQuoteIndex) {
                updateFavoriteIcon();
            }
        }

        window.onload = function() {
            init();
        };
    </script>
</body>
</html>
